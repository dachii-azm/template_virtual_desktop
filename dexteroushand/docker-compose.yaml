x-default-volumes: &default-volumes
  - type: volume
    source: dexteroushand-volume
    target: ${DOCKER_ROOT_PATH}/volume
  -type: bind
    source: /tmp/.X11-unix
    target: /tmp/.X11-unix
  - type: bind
    source: /etc/localtime
    target: /etc/localtime
    read_only: true
  - type: bind
    source: ${HOST_WORK_PATH}/Data/dexteroushand
    target: ${DOCKER_WORK_PATH}/Data/dexteroushand
  - type: bind
    source: ${HOST_WORK_PATH}/Project/dexteroushand
    target: ${DOCKER_WORK_PATH}/Project/dexteroushand
  
  x-default-environment: &default-environment
    - DISPLAY
    - QT_X11_NO_MITSHM=1
    - XAUTHORITY=${TMP_XAUTH}

  x-default-deploy: &default-deploy
    resources:
      reservations:
        devices:
          - driver: nvidia
            count: all
            capabilities: [ gpu ]

services:
  # This service is the vnc desktop image
  dachii-desktop:
    image: ghcr.io/matsuolab/virtual_desktop:latest
    runtime: nvidia
    environment: *default-environment
    ports:
      - "${WEB_PORT}:6080"
    volumes:
      - "/tmp/.X11-unix:/tmp/.X11-unix:rw"
    security_opt:
      - seccomp:unconfined
    deploy: *default-deploy
  
  dexteroushand-base:
    profiles: [ "base" ]
    build:
      context: ./
      dockerfile: Dockerfile.base